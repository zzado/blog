---
import Layout from '../../../layouts/Layout.astro';
import { getCollection } from 'astro:content';
import { useTranslations } from '../../../i18n/utils';

const lang = 'ko';
const t = useTranslations(lang);

const { BASE_URL } = import.meta.env;
const homeUrl = BASE_URL.endsWith('/') ? BASE_URL : BASE_URL + '/';

const allPosts = await getCollection('blog');
const posts = allPosts
    .filter(post => post.id.startsWith('ko/'))
    .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());
---

<Layout>
	<div class="max-w-4xl mx-auto px-4 py-8 sm:px-6 lg:px-8">
		<div class="flex justify-between items-center mb-8">
			<h1 class="text-3xl font-bold text-gray-900 dark:text-white">{t('posts.title')}</h1>
            
            <div class="flex items-center gap-4">
                <!-- Search Input -->
                <div class="relative">
                    <input type="text" id="search-input" placeholder={t('posts.search_placeholder')} class="pl-10 pr-4 py-2 border border-gray-300 dark:border-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-800 dark:text-white" />
                    <svg class="w-5 h-5 text-gray-400 absolute left-3 top-1/2 transform -translate-y-1/2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                </div>

                <!-- View Toggle Button -->
                <button id="view-toggle" class="p-2 text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 focus:outline-none hidden md:block" title="Toggle View">
                    <!-- Grid Icon (Show when in List View) -->
                    <svg id="icon-grid" class="hidden w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"></path></svg>
                    <!-- List Icon (Show when in Grid View) -->
                    <svg id="icon-list" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                </button>
            </div>
		</div>

		<div id="posts-container" class="grid gap-8 md:grid-cols-2">
			{
				posts.map((post) => (
					<article class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 hover:shadow-md transition-shadow overflow-hidden group post-item" data-title={post.data.title.toLowerCase()} data-desc={post.data.description.toLowerCase()} data-tags={post.data.tags.join(',').toLowerCase()}>
						<a href={`${homeUrl}posts/${post.slug.replace(/^ko\//, '')}`} class="block h-full card-link">
							{post.data.heroImage && (
								<img width={720} height={360} src={post.data.heroImage.startsWith('/') ? homeUrl + post.data.heroImage.substring(1) : post.data.heroImage} alt="" class="w-full h-48 object-cover card-image transition-all duration-300" />
							)}
							<div class="p-6 card-content">
								<h2 class="text-xl font-semibold text-gray-900 dark:text-white mb-2 group-hover:text-blue-600 dark:group-hover:text-blue-400">
									{post.data.title}
								</h2>
								<p class="text-sm text-gray-500 dark:text-gray-400 mb-4">
                                    {post.data.pubDate.toLocaleDateString('ko-KR')}
								</p>
                                <p class="text-gray-600 dark:text-gray-300 line-clamp-3 card-desc mb-4">
                                    {post.data.description}
                                </p>
                                <div class="flex flex-wrap gap-2">
                                    {post.data.tags.map(tag => (
                                        <span class="px-2 py-1 bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300 text-xs rounded-full">#{tag}</span>
                                    ))}
                                </div>
							</div>
						</a>
					</article>
				))
			}
            {posts.length === 0 && (
                <p class="text-gray-500 dark:text-gray-400 col-span-2 text-center py-10">
                    {t('posts.empty')}
                </p>
            )}
		</div>
	</div>
</Layout>

<script is:inline>
    function setupViewToggle() {
        const toggleBtn = document.getElementById('view-toggle');
        const container = document.getElementById('posts-container');
        const iconGrid = document.getElementById('icon-grid');
        const iconList = document.getElementById('icon-list');
        const cardLinks = document.querySelectorAll('.card-link');
        const images = document.querySelectorAll('.card-image');
        const contents = document.querySelectorAll('.card-content');
        const searchInput = document.getElementById('search-input');
        const postItems = document.querySelectorAll('.post-item');

        // Check local storage for preference
        let isListView = localStorage.getItem('posts-view') === 'list';

        function updateView() {
            if (isListView) {
                // List View Styles
                container.classList.remove('md:grid-cols-2');
                container.classList.add('grid-cols-1');
                
                // Switch to Flex Row for List View
                cardLinks.forEach(link => {
                    link.classList.add('flex', 'flex-row');
                    link.classList.remove('block');
                });

                // Adjust Image Style for List View
                images.forEach(img => {
                    img.classList.remove('w-full', 'h-48');
                    img.classList.add('w-48', 'h-auto', 'min-h-full'); // Fixed width, auto height
                });

                // Adjust Content Padding if needed
                contents.forEach(content => {
                    content.classList.add('flex-1'); // Take remaining space
                });

                iconGrid.classList.remove('hidden');
                iconList.classList.add('hidden');
            } else {
                // Grid View Styles
                container.classList.add('md:grid-cols-2');
                container.classList.remove('grid-cols-1');
                
                // Revert to Block for Grid View
                cardLinks.forEach(link => {
                    link.classList.remove('flex', 'flex-row');
                    link.classList.add('block');
                });

                // Revert Image Style
                images.forEach(img => {
                    img.classList.add('w-full', 'h-48');
                    img.classList.remove('w-48', 'h-auto', 'min-h-full');
                });

                contents.forEach(content => {
                    content.classList.remove('flex-1');
                });
                
                iconGrid.classList.add('hidden');
                iconList.classList.remove('hidden');
            }
        }

        // Search Functionality
        if (searchInput) {
            const newSearchInput = searchInput.cloneNode(true);
            searchInput.parentNode.replaceChild(newSearchInput, searchInput);

            newSearchInput.addEventListener('input', (e) => {
                const term = e.target.value.toLowerCase();
                
                postItems.forEach(item => {
                    const title = item.dataset.title;
                    const desc = item.dataset.desc;
                    const tags = item.dataset.tags;

                    if (title.includes(term) || desc.includes(term) || tags.includes(term)) {
                        item.classList.remove('hidden');
                    } else {
                        item.classList.add('hidden');
                    }
                });
            });
        }

        // Initialize
        updateView();

        if (toggleBtn) {
            // Remove old listener
            const newBtn = toggleBtn.cloneNode(true);
            toggleBtn.parentNode.replaceChild(newBtn, toggleBtn);

            newBtn.addEventListener('click', () => {
                isListView = !isListView;
                localStorage.setItem('posts-view', isListView ? 'list' : 'grid');
                updateView();
            });
        }
    }

    document.addEventListener('astro:page-load', setupViewToggle);
    setupViewToggle();
</script>
