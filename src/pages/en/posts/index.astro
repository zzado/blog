---
import Layout from '../../../layouts/Layout.astro';
import { getCollection } from 'astro:content';
import { useTranslations } from '../../../i18n/utils';

const lang = 'en';
const t = useTranslations(lang);

const { BASE_URL } = import.meta.env;
const homeUrl = BASE_URL.endsWith('/') ? BASE_URL : BASE_URL + '/';

const allPosts = await getCollection('blog');
const posts = allPosts
    .filter(post => post.id.startsWith('en/'))
    .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());
---

<Layout>
	<div class="max-w-4xl mx-auto px-4 py-8 sm:px-6 lg:px-8">
		<div class="flex justify-between items-center mb-8">
			<h1 class="text-3xl font-bold text-gray-900 dark:text-white">{t('posts.title')}</h1>
            
            <div class="flex items-center gap-4">
                <!-- Search Input -->
                <div class="relative">
                    <input type="text" id="search-input" placeholder={t('posts.search_placeholder')} class="pl-10 pr-4 py-2 border border-gray-300 dark:border-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-800 dark:text-white" />
                    <svg class="w-5 h-5 text-gray-400 absolute left-3 top-1/2 transform -translate-y-1/2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                </div>

                <!-- View Toggle Buttons -->
                <div class="hidden md:flex items-center gap-1 border border-gray-300 dark:border-gray-600 rounded-lg p-1">
                    <!-- List Icon Button -->
                    <button id="btn-list" class="p-1.5 rounded transition-colors" title="List View">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                    </button>
                    <!-- Grid Icon Button -->
                    <button id="btn-grid" class="p-1.5 rounded transition-colors" title="Grid View">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"></path></svg>
                    </button>
                </div>
            </div>
		</div>

		<div id="posts-container" class="grid gap-8 md:grid-cols-2 transition-all duration-300 ease-in-out">
			{
				posts.map((post) => (
					<article class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 hover:shadow-md transition-shadow overflow-hidden group post-item transition-all duration-300 ease-in-out" data-title={post.data.title.toLowerCase()} data-desc={post.data.description.toLowerCase()} data-tags={post.data.tags.join(',').toLowerCase()}>
						<a href={`${homeUrl}en/posts/${post.slug.replace(/^en\//, '')}`} class="block h-full card-link">
							{post.data.heroImage && (
								<img width={720} height={360} src={post.data.heroImage.startsWith('/') ? homeUrl + post.data.heroImage.substring(1) : post.data.heroImage} alt="" class="w-full h-48 object-cover card-image transition-all duration-300" />
							)}
							<div class="p-6 card-content">
								<h2 class="text-xl font-semibold text-gray-900 dark:text-white mb-2 group-hover:text-blue-600 dark:group-hover:text-blue-400">
									{post.data.title}
								</h2>
								<p class="text-sm text-gray-500 dark:text-gray-400 mb-4">
                                    {post.data.pubDate.toLocaleDateString('en-US')}
								</p>
                                <p class="text-gray-600 dark:text-gray-300 line-clamp-3 card-desc mb-4">
                                    {post.data.description}
                                </p>
                                <div class="flex flex-wrap gap-2">
                                    {post.data.tags.map(tag => (
                                        <span class="px-2 py-1 bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300 text-xs rounded-full cursor-pointer hover:bg-blue-100 dark:hover:bg-blue-900 transition-colors post-tag">#{tag}</span>
                                    ))}
                                </div>
							</div>
						</a>
					</article>
				))
			}
            {posts.length === 0 && (
                <p class="text-gray-500 dark:text-gray-400 col-span-2 text-center py-10">
                    {t('posts.empty')}
                </p>
            )}
            
            <!-- No Search Results Message -->
            <div id="no-results" class="hidden col-span-2 text-center py-10">
                <p class="text-lg text-gray-500 dark:text-gray-400">No results found. ðŸ˜…</p>
                <button id="clear-search" class="mt-2 text-blue-500 hover:underline text-sm">Clear search</button>
            </div>
		</div>
	</div>
</Layout>

<script is:inline>
    function setupViewToggle() {
        const container = document.getElementById('posts-container');
        const searchInput = document.getElementById('search-input');
        const postItems = document.querySelectorAll('.post-item');
        const noResults = document.getElementById('no-results');
        const clearSearchBtn = document.getElementById('clear-search');

        // Check local storage for preference
        let isListView = localStorage.getItem('posts-view') === 'list';

        // Active/Inactive styles
        const activeClass = ['bg-gray-600', 'dark:bg-gray-500', 'text-white'];
        const inactiveClass = ['text-gray-400', 'dark:text-gray-500', 'hover:bg-gray-100', 'dark:hover:bg-gray-700'];

        function updateButtonStyles() {
            // Always get fresh references from DOM
            const btnListEl = document.getElementById('btn-list');
            const btnGridEl = document.getElementById('btn-grid');
            
            if (!btnListEl || !btnGridEl) return;

            // Remove all classes first
            [...activeClass, ...inactiveClass].forEach(cls => {
                btnListEl.classList.remove(cls);
                btnGridEl.classList.remove(cls);
            });

            if (isListView) {
                btnListEl.classList.add(...activeClass);
                btnGridEl.classList.add(...inactiveClass);
            } else {
                btnGridEl.classList.add(...activeClass);
                btnListEl.classList.add(...inactiveClass);
            }
        }

        function updateView() {
            const cardLinks = document.querySelectorAll('.card-link');
            const images = document.querySelectorAll('.card-image');
            const contents = document.querySelectorAll('.card-content');
            const descs = document.querySelectorAll('.card-desc');

            if (isListView) {
                // List View Styles - Compact
                container.classList.remove('md:grid-cols-2', 'gap-8');
                container.classList.add('grid-cols-1', 'gap-3');
                
                cardLinks.forEach(link => {
                    link.classList.add('flex', 'flex-row', 'items-center');
                    link.classList.remove('block');
                });

                images.forEach(img => {
                    img.classList.remove('w-full', 'h-48');
                    img.classList.add('w-32', 'h-full', 'object-cover', 'flex-shrink-0');
                });

                contents.forEach(content => {
                    content.classList.add('flex-1');
                    content.classList.remove('p-6');
                    content.classList.add('p-3');
                });

                // Hide description in list view
                descs.forEach(desc => {
                    desc.classList.add('hidden');
                });
            } else {
                // Grid View Styles
                container.classList.add('md:grid-cols-2', 'gap-8');
                container.classList.remove('grid-cols-1', 'gap-3');
                
                cardLinks.forEach(link => {
                    link.classList.remove('flex', 'flex-row', 'items-center');
                    link.classList.add('block');
                });

                images.forEach(img => {
                    img.classList.add('w-full', 'h-48');
                    img.classList.remove('w-32', 'h-full', 'flex-shrink-0');
                });

                contents.forEach(content => {
                    content.classList.remove('flex-1', 'p-3');
                    content.classList.add('p-6');
                });

                // Show description in grid view
                descs.forEach(desc => {
                    desc.classList.remove('hidden');
                });
            }
            updateButtonStyles();
        }

        // Search Functionality
        if (searchInput) {
            searchInput.addEventListener('input', (e) => {
                const term = e.target.value.toLowerCase();
                let visibleCount = 0;
                
                postItems.forEach(item => {
                    const title = item.dataset.title;
                    const desc = item.dataset.desc;
                    const tags = item.dataset.tags;

                    if (title.includes(term) || desc.includes(term) || tags.includes(term)) {
                        item.classList.remove('hidden');
                        visibleCount++;
                    } else {
                        item.classList.add('hidden');
                    }
                });

                if (visibleCount === 0 && term.length > 0) {
                    noResults.classList.remove('hidden');
                } else {
                    noResults.classList.add('hidden');
                }
            });
        }

        // Clear Search
        if (clearSearchBtn && searchInput) {
            clearSearchBtn.addEventListener('click', () => {
                searchInput.value = '';
                searchInput.dispatchEvent(new Event('input'));
                searchInput.focus();
            });
        }

        // Event Delegation for View Toggle & Tags
        document.addEventListener('click', (e) => {
            const btnList = e.target.closest('#btn-list');
            const btnGrid = e.target.closest('#btn-grid');
            const tagBtn = e.target.closest('.post-tag');

            if (btnList) {
                isListView = true;
                localStorage.setItem('posts-view', 'list');
                updateView();
            } else if (btnGrid) {
                isListView = false;
                localStorage.setItem('posts-view', 'grid');
                updateView();
            } else if (tagBtn) {
                // Tag filtering logic
                e.preventDefault(); // Prevent link click if wrapped in <a>
                const tagText = tagBtn.innerText.replace('#', '').toLowerCase();
                if (searchInput) {
                    searchInput.value = tagText;
                    searchInput.dispatchEvent(new Event('input'));
                    // Scroll to top to see results
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                }
            }
        });

        // Initialize
        updateView();
    }

    document.addEventListener('astro:page-load', setupViewToggle);
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', setupViewToggle);
    } else {
        setupViewToggle();
    }
</script>
