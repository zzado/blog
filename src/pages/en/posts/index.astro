---
import Layout from '../../../layouts/Layout.astro';
import { getCollection } from 'astro:content';
import { useTranslations } from '../../../i18n/utils';

const lang = 'en';
const t = useTranslations(lang);

const { BASE_URL } = import.meta.env;
const homeUrl = BASE_URL.endsWith('/') ? BASE_URL : BASE_URL + '/';

const allPosts = await getCollection('blog');
const posts = allPosts
    .filter(post => post.id.startsWith('en/'))
    .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());
---

<Layout>
	<div class="max-w-4xl mx-auto px-4 py-8 sm:px-6 lg:px-8">
		<div class="flex justify-between items-center mb-8">
			<h1 class="text-3xl font-bold text-gray-900 dark:text-white">{t('posts.title')}</h1>
			<!-- View Toggle Button -->
			<button id="view-toggle" class="p-2 text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 focus:outline-none hidden md:block" title="Toggle View">
				<svg id="icon-grid" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"></path></svg>
				<svg id="icon-list" class="hidden w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
			</button>
		</div>

		<div id="posts-container" class="grid gap-8 md:grid-cols-2">
			{
				posts.map((post) => (
					<article class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 hover:shadow-md transition-shadow overflow-hidden group">
						<a href={`${homeUrl}en/posts/${post.slug.replace(/^en\//, '')}`} class="block h-full card-link">
							{post.data.heroImage && (
								<img width={720} height={360} src={post.data.heroImage.startsWith('/') ? homeUrl + post.data.heroImage.substring(1) : post.data.heroImage} alt="" class="w-full h-48 object-cover card-image transition-all duration-300" />
							)}
							<div class="p-6 card-content">
								<h2 class="text-xl font-semibold text-gray-900 dark:text-white mb-2 group-hover:text-blue-600 dark:group-hover:text-blue-400">
									{post.data.title}
								</h2>
								<p class="text-sm text-gray-500 dark:text-gray-400 mb-4">
                                    {post.data.pubDate.toLocaleDateString('en-US')}
								</p>
                                <p class="text-gray-600 dark:text-gray-300 line-clamp-3 card-desc">
                                    {post.data.description}
                                </p>
							</div>
						</a>
					</article>
				))
			}
            {posts.length === 0 && (
                <p class="text-gray-500 dark:text-gray-400 col-span-2 text-center py-10">
                    {t('posts.empty')}
                </p>
            )}
		</div>
	</div>
</Layout>

<script is:inline>
    function setupViewToggle() {
        const toggleBtn = document.getElementById('view-toggle');
        const container = document.getElementById('posts-container');
        const iconGrid = document.getElementById('icon-grid');
        const iconList = document.getElementById('icon-list');
        const cardLinks = document.querySelectorAll('.card-link');
        const images = document.querySelectorAll('.card-image');
        const contents = document.querySelectorAll('.card-content');

        let isListView = localStorage.getItem('posts-view') === 'list';

        function updateView() {
            if (isListView) {
                container.classList.remove('md:grid-cols-2');
                container.classList.add('grid-cols-1');
                
                cardLinks.forEach(link => {
                    link.classList.add('flex', 'flex-row');
                    link.classList.remove('block');
                });

                images.forEach(img => {
                    img.classList.remove('w-full', 'h-48');
                    img.classList.add('w-48', 'h-auto', 'min-h-full');
                });

                contents.forEach(content => {
                    content.classList.add('flex-1');
                });

                iconGrid.classList.add('hidden');
                iconList.classList.remove('hidden');
            } else {
                container.classList.add('md:grid-cols-2');
                container.classList.remove('grid-cols-1');
                
                cardLinks.forEach(link => {
                    link.classList.remove('flex', 'flex-row');
                    link.classList.add('block');
                });

                images.forEach(img => {
                    img.classList.add('w-full', 'h-48');
                    img.classList.remove('w-48', 'h-auto', 'min-h-full');
                });

                contents.forEach(content => {
                    content.classList.remove('flex-1');
                });

                iconGrid.classList.remove('hidden');
                iconList.classList.add('hidden');
            }
        }

        updateView();

        if (toggleBtn) {
            const newBtn = toggleBtn.cloneNode(true);
            toggleBtn.parentNode.replaceChild(newBtn, toggleBtn);

            newBtn.addEventListener('click', () => {
                isListView = !isListView;
                localStorage.setItem('posts-view', isListView ? 'list' : 'grid');
                updateView();
            });
        }
    }

    document.addEventListener('astro:page-load', setupViewToggle);
    setupViewToggle();
</script>
